{"version":3,"file":"WeeklyCalendarView.vue2.js","sources":["../../../../src/vue/components/calendar/WeeklyCalendarView.vue"],"sourcesContent":["<script setup lang=\"ts\">\nimport { ref, watch, computed } from 'vue'\nimport dayjs from 'dayjs'\nimport utc from 'dayjs/plugin/utc'\nimport dayJsTimezone from 'dayjs/plugin/timezone'\n\ndayjs.extend(utc)\ndayjs.extend(dayJsTimezone)\n\nimport EventTimeRange from './EventTimeRange.vue'\nimport type { CalendarEvent, TimeSlot } from '../../constants/calendar'\nimport {\n  type EventLayout,\n  findEventClusters,\n  calculateClusterLayouts,\n  getEventKey,\n} from '../../utils/event-layout-utils'\nimport isSameOrBefore from 'dayjs/plugin/isSameOrBefore'\nimport isSameOrAfter from 'dayjs/plugin/isSameOrAfter'\n\ndayjs.extend(isSameOrBefore)\ndayjs.extend(isSameOrAfter)\n\ninterface Props {\n  timezone?: string\n  now: Date\n  events: CalendarEvent[]\n  locale: string\n}\n\nconst props = withDefaults(defineProps<Props>(), {\n  timezone: 'UTC',\n})\n\nconst DAYS_OF_WEEK = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']\n\nconst timeSlots = ref<TimeSlot[]>([])\nconst isReady = ref(false)\n\nconst now = computed(() => props.now)\nconst events = computed(() => props.events)\n\n// Calculate current hour info - memoized for performance\nconst currentHourInfo = computed(() => {\n  const currentHour = parseInt(\n    new Date(now.value).toLocaleString('en-US', {\n      hour: 'numeric',\n      hour12: false,\n      timeZone: props.timezone,\n    }),\n  )\n  return {\n    current: currentHour,\n    start: currentHour - 1,\n    windowStart: (currentHour - 2 + 24) % 24,\n  }\n})\n\n// Calculate start of week date - memoized for performance\nconst weekStart = computed(() => {\n  const d = new Date(now.value)\n  const day = d.getDay()\n  d.setDate(d.getDate() - day)\n  d.setHours(0, 0, 0, 0)\n  return d\n})\n\n// Pre-computed event map for better performance\nconst eventMap = computed(() => {\n  if (!events.value || timeSlots.value.length === 0) return new Map()\n\n  const map = new Map<string, CalendarEvent[]>()\n\n  // Get the visible hour range from time slots\n  const visibleHours = timeSlots.value.map((slot) => slot.hour)\n  const minVisibleHour = Math.min(...visibleHours)\n  const maxVisibleHour = Math.max(...visibleHours)\n\n  // Determine if we're in the afternoon/evening window (1 PM to 12:00 AM)\n  // or morning window (current time to 11:00 AM)\n  const currentHour = currentHourInfo.value.current\n  const isAfternoonWindow = currentHour > 12\n\n  events.value.forEach((event) => {\n    const eventStart = new Date(event.startTime)\n\n    // Use toLocaleString for proper hour and day extraction\n    const eventHour = parseInt(\n      eventStart.toLocaleString('en-US', {\n        hour: 'numeric',\n        hour12: false,\n        timeZone: props.timezone,\n      }),\n    )\n\n    const eventDayOfWeek = eventStart.toLocaleString('en-US', {\n      weekday: 'long',\n      timeZone: props.timezone,\n    })\n\n    const dayIndex = DAYS_OF_WEEK.findIndex((day) =>\n      day.toLowerCase().startsWith(eventDayOfWeek.toLowerCase().slice(0, 3)),\n    )\n\n    // Only add events that fall within the visible time range\n    // For afternoon window: exclude hour 0 (12:00 AM)\n    // For morning window: include all visible hours\n    const isInVisibleRange =\n      dayIndex >= 0 &&\n      dayIndex < 7 &&\n      eventHour >= minVisibleHour &&\n      eventHour <= maxVisibleHour &&\n      (!isAfternoonWindow || eventHour !== 0)\n\n    if (isInVisibleRange) {\n      const key = `${dayIndex}-${eventHour}`\n      if (!map.has(key)) {\n        map.set(key, [])\n      }\n      map.get(key)!.push(event)\n    }\n  })\n\n  return map\n})\n\n// Calculate event layouts using a column-based algorithm (Google Calendar style)\n// This is per day, so we group events by day and compute layouts for each day\nconst eventLayouts = computed(() => {\n  const layoutMap = new Map<string, EventLayout>()\n  const eventsByDay = new Map<number, CalendarEvent[]>()\n\n  // Group events by day\n  const allWeekEvents = events.value.filter((event) => {\n    const eventStart = dayjs(event.startTime).tz(props.timezone)\n    const weekStartDate = dayjs(weekStart.value).tz(props.timezone)\n    return (\n      !eventStart.isBefore(weekStartDate) &&\n      eventStart.isBefore(weekStartDate.add(7, 'day'))\n    )\n  })\n\n  allWeekEvents.forEach((event) => {\n    const eventStart = dayjs(event.startTime).tz(props.timezone)\n    const weekStartDate = dayjs(weekStart.value).tz(props.timezone)\n    const dayDiff = eventStart.diff(weekStartDate, 'day')\n    const dayIndex = dayDiff % 7\n\n    if (!eventsByDay.has(dayIndex)) {\n      eventsByDay.set(dayIndex, [])\n    }\n    eventsByDay.get(dayIndex)!.push(event)\n  })\n\n  // Compute layouts for each day independently using shared utilities\n  for (let dayIndex = 0; dayIndex < 7; dayIndex++) {\n    const dayEvents = eventsByDay.get(dayIndex) || []\n    if (dayEvents.length === 0) continue\n\n    // Find clusters of overlapping events\n    const clusters = findEventClusters(dayEvents, props.timezone)\n\n    // Calculate layouts for each cluster and add to the map\n    for (const cluster of clusters) {\n      const clusterLayouts = calculateClusterLayouts(cluster, props.timezone)\n      for (const [event, layout] of clusterLayouts) {\n        layoutMap.set(getEventKey(event), layout)\n      }\n    }\n  }\n\n  return layoutMap\n})\n\nconst getEventLayout = (\n  event: CalendarEvent,\n): { index: number; total: number; span: number } => {\n  const layout = eventLayouts.value.get(getEventKey(event))\n  if (!layout) {\n    return { index: 0, total: 1, span: 1 }\n  }\n  return {\n    index: layout.column,\n    total: layout.totalColumns,\n    span: layout.columnSpan,\n  }\n}\n\n// Generate time slots - optimized for performance\nconst generateTimeSlots = async () => {\n  try {\n    const userLocale = props.locale\n\n    const slots: TimeSlot[] = []\n    const currentHour = currentHourInfo.value.current\n\n    // Calculate dynamic 12-hour window based on current time\n    // Constraints: 12 slots, ending at 12:00 AM (midnight)\n    let startHour: number\n\n    if (currentHour > 12) {\n      // Afternoon/Evening: Show window ending at midnight\n      // Always show 11 hours before midnight to midnight (1:00 PM to 12:00 AM)\n      startHour = 13 // 1:00 PM\n    } else {\n      // Morning: Show window ending at midnight of the same day\n      // For current time X, show X to X+11 (ending at midnight)\n      startHour = currentHour\n    }\n\n    // Generate slots for the 12-hour window\n    for (let i = 0; i < 12; i++) {\n      const hour = (startHour + i) % 24\n\n      // Use toLocaleTimeString for proper formatting\n      const baseDate = new Date(now.value)\n      baseDate.setHours(hour, 0, 0, 0)\n      const timeString = baseDate.toLocaleTimeString(userLocale, {\n        hour: 'numeric',\n        minute: '2-digit',\n      })\n\n      slots.push({\n        time: timeString,\n        hour,\n      })\n    }\n\n    timeSlots.value = slots\n    isReady.value = true\n  } catch (error) {\n    console.error('Error generating time slots:', error)\n    // Fallback to simple time slots if locale fetch fails\n    const slots: TimeSlot[] = []\n    const currentHour = currentHourInfo.value.current\n\n    // Calculate dynamic 12-hour window based on current time\n    let startHour: number\n\n    if (currentHour > 12) {\n      // Afternoon/Evening: Show window ending at midnight\n      startHour = 13 // 1:00 PM\n    } else {\n      // Morning: Show window ending at midnight of the same day\n      startHour = currentHour\n    }\n\n    for (let i = 0; i < 12; i++) {\n      const hour = (startHour + i) % 24\n\n      // Fix the 12-hour format to properly show 12 AM\n      const formattedHour = hour === 0 ? 12 : hour % 12 || 12\n      const ampm = hour < 12 ? 'AM' : 'PM'\n\n      slots.push({\n        time: `${formattedHour}:00 ${ampm}`,\n        hour,\n      })\n    }\n    timeSlots.value = slots\n    isReady.value = true\n  }\n}\n\n// Get events for a specific time slot and day - optimized with pre-computed map\nconst getEventsForTimeSlot = (\n  hour: number,\n  dayOffset: number,\n): CalendarEvent[] => {\n  const key = `${dayOffset}-${hour}`\n  return eventMap.value.get(key) || []\n}\n\n// Get header date for a specific day\nconst getHeaderDate = (dayIndex: number): number => {\n  const date = new Date(weekStart.value)\n  date.setDate(date.getDate() + dayIndex)\n  return date.getDate()\n}\n\n// Check if a day is today\nconst isToday = (dayIndex: number): boolean => {\n  const date = new Date(weekStart.value)\n  date.setDate(date.getDate() + dayIndex)\n  const today = new Date(now.value)\n  return (\n    date.getDate() === today.getDate() &&\n    date.getMonth() === today.getMonth() &&\n    date.getFullYear() === today.getFullYear()\n  )\n}\n\n// Memoized event style computation\nconst eventStyleCache = new Map<string, Record<string, string>>()\n\n// Get wrapper style for an event (positioning only) - with caching for better performance\nconst getWrapperStyle = (event: CalendarEvent): Record<string, string> => {\n  // Get layout for this event using column-based algorithm (Google Calendar style)\n  const layout = getEventLayout(event)\n\n  // Create cache key that includes layout information to prevent collisions\n  // for events with identical start/end/backgroundColor but different positions\n  const cacheKey = `wrapper-${event.startTime}-${event.endTime}-${layout.index}-${layout.total}`\n\n  if (eventStyleCache.has(cacheKey)) {\n    return eventStyleCache.get(cacheKey)!\n  }\n\n  const startTime = dayjs(event.startTime).tz(props.timezone)\n  const endTime = dayjs(event.endTime).tz(props.timezone)\n\n  const startMinutes = startTime.minute()\n  const topOffset = startMinutes === 0 ? 50 : (startMinutes / 60) * 100 + 50\n\n  // Calculate duration using dayjs\n  const duration = endTime.diff(startTime, 'minute', true)\n  const durationHours = duration / 60\n\n  // Calculate the raw height\n  const rawHeight = durationHours * 100\n\n  // Determine the maximum visible height based on the last time slot\n  const lastVisibleHour =\n    timeSlots.value[timeSlots.value.length - 1]?.hour || 23\n\n  // For events that span across midnight, ensure they extend to at least touch the 12:00 AM line\n  let maxVisibleHeight: number\n  if (endTime.date() !== startTime.date()) {\n    // Event spans across midnight, ensure it extends to midnight (hour 0)\n    maxVisibleHeight = (24 - startTime.hour()) * 100\n  } else {\n    // Event is within the same day\n    maxVisibleHeight = (lastVisibleHour - startTime.hour()) * 100\n  }\n\n  // Limit the height to the maximum visible height\n  const height = Math.min(rawHeight, maxVisibleHeight)\n\n  // Add minimal gap between adjacent events (like Google Calendar)\n  // Reduce height by a small amount to create visual separation\n  const eventGap = 4 // 4% gap between events\n  const adjustedHeight = Math.max(height - eventGap, height * 0.9) // Ensure height doesn't go below 90% of original\n\n  // Calculate width and left position based on column layout\n  // Google Calendar style: events in earlier columns visually overlap into later columns\n  const columnWidth = 100 / layout.total\n  const eventSpan = layout.span && layout.span > 0 ? layout.span : 1\n  const baseWidth = columnWidth * eventSpan\n  const left = layout.index * columnWidth\n\n  // Events overlap into the next column's space (except the last column)\n  const overlapRatio = 0.7\n  const isLastColumn = layout.index + eventSpan >= layout.total\n  const overlapBonus = isLastColumn ? 0 : columnWidth * overlapRatio\n  const width = baseWidth + overlapBonus\n\n  // Z-index: higher column numbers appear on top\n  const zIndex = 2 + layout.index\n\n  const endHour = endTime.hour()\n\n  // Create the wrapper style object (positioning only)\n  const wrapperStyle: Record<string, string> = {\n    top: `${topOffset}%`,\n    height: `${adjustedHeight}%`,\n    width: `${width}%`,\n    left: `${left}%`,\n    'z-index': `${zIndex}`,\n  }\n\n  // Check if the event extends beyond the visible time slots\n  if (\n    endHour >= lastVisibleHour ||\n    (endTime.date() !== startTime.date() &&\n      timeSlots.value[0] &&\n      endHour < timeSlots.value[0].hour)\n  ) {\n    wrapperStyle['border-bottom-left-radius'] = '0'\n    wrapperStyle['border-bottom-right-radius'] = '0'\n  }\n\n  // Cache the result\n  eventStyleCache.set(cacheKey, wrapperStyle)\n\n  // Limit cache size to prevent memory leaks\n  if (eventStyleCache.size > 100) {\n    const firstKey = eventStyleCache.keys().next().value\n    if (firstKey) {\n      eventStyleCache.delete(firstKey)\n    }\n  }\n\n  return wrapperStyle\n}\n\n// Get item style for an event (background-color only)\nconst getItemStyle = (event: CalendarEvent): Record<string, string> => {\n  if (event.backgroundColor) {\n    return { 'background-color': event.backgroundColor }\n  }\n  return {}\n}\n\n// Clear style cache when events change\nwatch(\n  events,\n  () => {\n    eventStyleCache.clear()\n  },\n  { deep: true },\n)\n\n// Get month/year display\nconst monthYearDisplay = computed(() => {\n  if (!props.locale) return ''\n  try {\n    const date = new Date(now.value)\n    const monthYear = date.toLocaleDateString(props.locale, {\n      month: 'long',\n      year: 'numeric',\n    })\n    const parts = monthYear.split(' ')\n    const month = parts[0]\n    const year = parts[1]\n    if (!month || !year) {\n      throw new Error('Invalid month/year format')\n    }\n    return `${month.toUpperCase()} ${year}`\n  } catch (error) {\n    console.error('Error formatting month/year:', error)\n    // Fallback to simple format\n    const date = new Date(now.value)\n    const monthNames = [\n      'January',\n      'February',\n      'March',\n      'April',\n      'May',\n      'June',\n      'July',\n      'August',\n      'September',\n      'October',\n      'November',\n      'December',\n    ]\n    const monthIndex = date.getMonth()\n    const monthName = monthNames[monthIndex]\n    if (!monthName) {\n      throw new Error(`Invalid month index: ${monthIndex}`)\n    }\n    return `${monthName.toUpperCase()} ${date.getFullYear()}`\n  }\n})\n\n// Calculate current time position for the red line\nconst currentTimePosition = computed(() => {\n  if (timeSlots.value.length === 0) return 0\n\n  const currentHour = parseInt(\n    now.value.toLocaleString('en-US', {\n      hour: 'numeric',\n      hour12: false,\n      timeZone: props.timezone,\n    }),\n  )\n  const currentMinute = now.value.getMinutes()\n\n  // Find the time slot that contains the current hour\n  const currentSlotIndex = timeSlots.value.findIndex(\n    (slot) => slot.hour === currentHour,\n  )\n\n  if (currentSlotIndex === -1) return -1 // Hide indicator if current time is not in visible range\n\n  // Calculate the percentage position within the current hour\n  // Add 30 minutes to move the line further down\n  const minutePercentage = (currentMinute + 30) / 60\n\n  // Calculate position as percentage of total visible time slots\n  const position =\n    ((currentSlotIndex + minutePercentage) / timeSlots.value.length) * 100\n\n  return Math.max(0, Math.min(100, position))\n})\n\n// Check if current time indicator should be visible\nconst showCurrentTimeIndicator = computed(() => {\n  return currentTimePosition.value >= 0 && currentTimePosition.value <= 100\n})\n\n// Clear style cache when events or time slots change\nwatch(\n  [events, timeSlots],\n  () => {\n    eventStyleCache.clear()\n  },\n  { deep: true },\n)\n\nwatch([now, () => props.timezone, currentHourInfo], generateTimeSlots, {\n  immediate: true,\n})\n\n// Update current time position every minute for smooth movement\nwatch(\n  now,\n  () => {\n    // Force reactivity update for current time position\n    // The computed property will automatically recalculate\n  },\n  { immediate: true },\n)\n</script>\n\n<template>\n  <div class=\"primary-card weekly-view\">\n    <div v-if=\"!isReady || timeSlots.length === 0\" class=\"weekly-calendar\">\n      <div style=\"padding: 2rem; text-align: center\">Loading calendar...</div>\n    </div>\n    <div v-else class=\"weekly-calendar\">\n      <div class=\"month-year-header\">{{ monthYearDisplay }}</div>\n      <div class=\"week-header\">\n        <div class=\"time-label-spacer\" />\n        <div v-for=\"(day, index) in DAYS_OF_WEEK\" :key=\"day\" class=\"day-header\">\n          <span>{{ day }} </span>\n          <span :class=\"{ 'current-date': isToday(index) }\">\n            {{ getHeaderDate(index) }}\n          </span>\n        </div>\n      </div>\n      <div class=\"week-body\">\n        <div v-for=\"slot in timeSlots\" :key=\"slot.hour\" class=\"week-row\">\n          <div class=\"time-label\">{{ slot.time }}</div>\n          <div\n            v-for=\"(_, dayIndex) in DAYS_OF_WEEK\"\n            :key=\"`${dayIndex}-${slot.hour}`\"\n            class=\"day-column\"\n          >\n            <div class=\"hour-line\" />\n            <div\n              v-for=\"event in getEventsForTimeSlot(slot.hour, dayIndex)\"\n              :key=\"event.startTime\"\n              class=\"calendar-event-wrapper\"\n              :style=\"getWrapperStyle(event)\"\n            >\n              <div class=\"calendar-event-item\" :style=\"getItemStyle(event)\">\n                <div class=\"event-title\">{{ event.title }}</div>\n                <EventTimeRange\n                  :start-time=\"event.startTime\"\n                  :end-time=\"event.endTime\"\n                  :locale=\"props.locale\"\n                  :timezone=\"props.timezone\"\n                />\n              </div>\n            </div>\n          </div>\n        </div>\n        <div\n          v-if=\"showCurrentTimeIndicator\"\n          class=\"current-time-indicator\"\n          :style=\"{ top: `${currentTimePosition}%` }\"\n        />\n      </div>\n    </div>\n  </div>\n</template>\n\n<style scoped lang=\"scss\">\n@use '../../styles/calendar/weekly-calendar-view';\n</style>\n"],"names":["dayjs","utc","dayJsTimezone","isSameOrBefore","isSameOrAfter","props","__props","DAYS_OF_WEEK","timeSlots","ref","isReady","now","computed","events","currentHourInfo","currentHour","weekStart","d","day","eventMap","map","visibleHours","slot","minVisibleHour","maxVisibleHour","isAfternoonWindow","event","eventStart","eventHour","eventDayOfWeek","dayIndex","key","eventLayouts","layoutMap","eventsByDay","weekStartDate","dayEvents","clusters","findEventClusters","cluster","clusterLayouts","calculateClusterLayouts","layout","getEventKey","getEventLayout","generateTimeSlots","userLocale","slots","startHour","i","hour","baseDate","timeString","error","formattedHour","ampm","getEventsForTimeSlot","dayOffset","getHeaderDate","date","isToday","today","eventStyleCache","getWrapperStyle","cacheKey","startTime","endTime","startMinutes","topOffset","rawHeight","lastVisibleHour","maxVisibleHeight","height","adjustedHeight","columnWidth","eventSpan","baseWidth","left","overlapBonus","width","zIndex","endHour","wrapperStyle","firstKey","getItemStyle","watch","monthYearDisplay","parts","month","year","monthNames","monthIndex","monthName","currentTimePosition","currentMinute","currentSlotIndex","minutePercentage","position","showCurrentTimeIndicator","_openBlock","_createElementBlock","_hoisted_1","_hoisted_2","_cache","_createElementVNode","_hoisted_3","_hoisted_4","_toDisplayString","_hoisted_5","_Fragment","_renderList","index","_normalizeClass","_hoisted_6","_hoisted_7","_","_normalizeStyle","_hoisted_8","_createVNode","EventTimeRange"],"mappings":"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"}