{"version":3,"file":"base-settings-store.js","sources":["../../../src/vue/stores/base-settings-store.ts"],"sourcesContent":["import { ref } from 'vue'\nimport {\n  getSettings,\n  getSettingWithDefault,\n  getTheme,\n  getCorsProxyUrl,\n} from '../../utils/settings.js'\n\nexport const baseSettingsStoreSetup = () => {\n  const settings = ref(getSettings())\n  const primaryThemeColor = ref('')\n  const secondaryThemeColor = ref('')\n  const tertiaryThemeColor = ref('')\n  const backgroundThemeColor = ref('')\n  const brandLogoUrl = ref('')\n\n  const setupTheme = () => {\n    const tertiaryColor = '#FFFFFF'\n    const backgroundColor = '#C9CDD0'\n    const defaultPrimaryColor = '#972EFF'\n    let secondaryColor = '#454BD2'\n\n    const accentColor = getSettingWithDefault<string>(\n      'screenly_color_accent',\n      '',\n    )\n    const primaryColor =\n      !accentColor || accentColor.toLowerCase() === '#ffffff'\n        ? defaultPrimaryColor\n        : accentColor\n\n    const theme = getTheme()\n    if (theme === 'light') {\n      const lightColor = getSettingWithDefault<string>(\n        'screenly_color_light',\n        '',\n      )\n      secondaryColor =\n        !lightColor || lightColor.toLowerCase() === '#ffffff'\n          ? '#adafbe'\n          : lightColor\n    } else if (theme === 'dark') {\n      const darkColor = getSettingWithDefault<string>(\n        'screenly_color_dark',\n        '',\n      )\n      secondaryColor =\n        !darkColor || darkColor.toLowerCase() === '#ffffff'\n          ? '#adafbe'\n          : darkColor\n    }\n\n    document.documentElement.style.setProperty(\n      '--theme-color-primary',\n      primaryColor,\n    )\n    document.documentElement.style.setProperty(\n      '--theme-color-secondary',\n      secondaryColor,\n    )\n    document.documentElement.style.setProperty(\n      '--theme-color-tertiary',\n      tertiaryColor,\n    )\n    document.documentElement.style.setProperty(\n      '--theme-color-background',\n      backgroundColor,\n    )\n\n    primaryThemeColor.value = primaryColor\n    secondaryThemeColor.value = secondaryColor\n    tertiaryThemeColor.value = tertiaryColor\n    backgroundThemeColor.value = backgroundColor\n  }\n\n  const setupBrandingLogo = async () => {\n    const theme = getTheme() || 'light'\n    const corsProxyUrl = getCorsProxyUrl()\n\n    // Define settings\n    const lightLogo = getSettingWithDefault<string>('screenly_logo_light', '')\n    const darkLogo = getSettingWithDefault<string>('screenly_logo_dark', '')\n\n    // Set logo URLs based on theme\n    let logoUrl = ''\n    let fallbackUrl = ''\n\n    if (theme === 'light') {\n      logoUrl = lightLogo\n        ? `${corsProxyUrl}/${lightLogo}`\n        : `${corsProxyUrl}/${darkLogo}`\n      fallbackUrl = lightLogo || darkLogo || ''\n    } else if (theme === 'dark') {\n      logoUrl = darkLogo\n        ? `${corsProxyUrl}/${darkLogo}`\n        : `${corsProxyUrl}/${lightLogo}`\n      fallbackUrl = darkLogo || lightLogo\n    }\n\n    // Function to fetch and process the image\n    const fetchImage = async (fileUrl: string): Promise<string> => {\n      try {\n        const response = await fetch(fileUrl)\n        if (!response.ok) {\n          throw new Error(\n            `Failed to fetch image from ${fileUrl}, status: ${response.status}`,\n          )\n        }\n\n        const blob = await response.blob()\n        const buffer = await blob.arrayBuffer()\n        const uintArray = new Uint8Array(buffer)\n\n        // Get the first 4 bytes for magic number detection\n        const hex = Array.from(uintArray.slice(0, 4))\n          .map((b) => b.toString(16).padStart(2, '0'))\n          .join('')\n          .toUpperCase()\n\n        // Convert the first few bytes to ASCII for text-based formats like SVG\n        const ascii = String.fromCharCode.apply(\n          null,\n          Array.from(uintArray.slice(0, 100)),\n        ) // Check first 100 chars for XML/SVG tags\n        const pngMagicNumber = '89504E47'\n        const jpegMagicNumber = 'FFD8FF'\n\n        // Determine file type based on MIME type, magic number, or ASCII text\n        if (ascii.startsWith('<?xml') || ascii.startsWith('<svg')) {\n          // Convert to Base64 using FileReader like the original\n          return new Promise((resolve, reject) => {\n            const svgReader = new FileReader()\n            svgReader.readAsText(blob)\n            svgReader.onloadend = function () {\n              try {\n                const base64 = btoa(\n                  unescape(encodeURIComponent(svgReader.result as string)),\n                )\n                resolve('data:image/svg+xml;base64,' + base64)\n              } catch (error) {\n                reject(error)\n              }\n            }\n            svgReader.onerror = () =>\n              reject(new Error('Failed to read SVG file'))\n          })\n        } else if (hex === pngMagicNumber || hex === jpegMagicNumber) {\n          // Checking PNG or JPEG/JPG magic number\n          return fileUrl\n        } else {\n          throw new Error('Unknown image type')\n        }\n      } catch (error) {\n        console.error('Error fetching image:', error)\n        throw error\n      }\n    }\n\n    // Try to fetch the image using the CORS proxy URL\n    try {\n      const processedLogoUrl = await fetchImage(logoUrl)\n      brandLogoUrl.value = processedLogoUrl\n    } catch {\n      // If CORS fails, try the fallback URL\n      try {\n        const processedFallbackUrl = await fetchImage(fallbackUrl)\n        brandLogoUrl.value = processedFallbackUrl\n      } catch {\n        // Set to empty string so the template uses the imported screenlyLogo\n        brandLogoUrl.value = fallbackUrl ?? ''\n      }\n    }\n  }\n\n  return {\n    settings,\n    primaryThemeColor,\n    secondaryThemeColor,\n    tertiaryThemeColor,\n    backgroundThemeColor,\n    brandLogoUrl,\n    setupTheme,\n    setupBrandingLogo,\n  }\n}\n\nexport type SettingsStore = ReturnType<typeof baseSettingsStoreSetup>\n"],"names":["baseSettingsStoreSetup","settings","ref","getSettings","primaryThemeColor","secondaryThemeColor","tertiaryThemeColor","backgroundThemeColor","brandLogoUrl","tertiaryColor","backgroundColor","defaultPrimaryColor","secondaryColor","accentColor","getSettingWithDefault","primaryColor","theme","getTheme","lightColor","darkColor","corsProxyUrl","getCorsProxyUrl","lightLogo","darkLogo","logoUrl","fallbackUrl","fetchImage","fileUrl","response","blob","buffer","uintArray","hex","b","ascii","pngMagicNumber","jpegMagicNumber","resolve","reject","svgReader","base64","error","processedLogoUrl","processedFallbackUrl"],"mappings":"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"}