name: Initialize Edge App
description: |
  This action creates and initializes a new edge app in the repository,
  including its deployment and instance setup for the specified environment.

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment for initialization (staging or production)'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

      edge_app_name:
        description: 'Folder name of the edge app (under edge-apps/) to initialize'
        required: true
        default: ''

      edge_app_title:
        description: 'Display title of the edge app (used in instance.yml)'
        required: true
        default: ''

run-name: Initializing ${{ inputs.edge_app_name }} in ${{ inputs.environment }}

jobs:
  deploy:
    name: Initialize App in ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    env:
      APP_PATH: edge-apps/${{ inputs.edge_app_name }}
      MANIFEST_FILE_NAME: ${{ inputs.environment == 'production' && 'screenly.yml' || 'screenly_qc.yml' }}

    steps:
      - name: Checkout master branch
        uses: actions/checkout@v4
        with:
          ref: master

      - name: Create Edge App
        uses: screenly/cli@master
        with:
          screenly_api_token: ${{ secrets.SCREENLY_API_TOKEN }}
          cli_commands: edge-app create --in-place --path=${{ env.APP_PATH }}

      - name: Deploy Edge App
        uses: screenly/cli@master
        with:
          screenly_api_token: ${{ secrets.SCREENLY_API_TOKEN }}
          cli_commands: edge-app deploy --path=${{ env.APP_PATH }}

      - name: Create Edge App Instance
        uses: screenly/cli@master
        with:
          screenly_api_token: ${{ secrets.SCREENLY_API_TOKEN }}
          cli_commands: edge-app instance create --path=${{ env.APP_PATH }}

      - name: Correct the instance name
        run: |
          sed -i "s/^name: .*/name: ${{ inputs.edge_app_title }}/" ${{ env.APP_PATH }}/instance.yml

      - name: Update Edge App Instance
        uses: screenly/cli@master
        with:
          screenly_api_token: ${{ secrets.SCREENLY_API_TOKEN }}
          cli_commands: edge-app instance update --path=${{ env.APP_PATH }}

      - name: Install yq (YAML parser)
        run: |
          sudo apt-get update && sudo apt-get install -y yq

      - name: Print Edge App ID from manifest
        run: |
          MANIFEST_FILE="${{ env.APP_PATH }}/${{ env.MANIFEST_FILE_NAME }}"
          echo " Reading App ID from: $MANIFEST_FILE"
          APP_ID=$(yq '.id' "$MANIFEST_FILE")
          echo " Edge App ID: $APP_ID"
        shell: bash
